name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: feishu-assistant-windows
            icon_ext: .ico
          - os: macos-latest
            artifact_name: feishu-assistant-macos
            icon_ext: .icns
          - os: ubuntu-latest
            artifact_name: feishu-assistant-linux
            icon_ext: .png

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev \
            libglib2.0-0 \
            libxkbcommon0 \
            libdbus-1-3 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libegl1

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller Pillow

      - name: Generate icon (Windows - ICO)
        if: runner.os == 'Windows'
        run: |
          python -c "
          from PIL import Image
          img = Image.open('images/iconfeishuLOGO.png')
          sizes = [(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)]
          img.save('icon.ico', format='ICO', sizes=sizes)
          print('Generated icon.ico')
          "

      - name: Generate icon (macOS - ICNS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p icon.iconset
          python -c "
          from PIL import Image
          img = Image.open('images/iconfeishuLOGO.png')
          sizes = [16, 32, 64, 128, 256, 512]
          for s in sizes:
              img.resize((s, s), Image.LANCZOS).save(f'icon.iconset/icon_{s}x{s}.png')
              s2 = s * 2
              if s2 <= 1024:
                  img.resize((s2, s2), Image.LANCZOS).save(f'icon.iconset/icon_{s}x{s}@2x.png')
          print('Generated iconset')
          "
          iconutil -c icns icon.iconset -o icon.icns

      - name: Generate icon (Linux - PNG)
        if: runner.os == 'Linux'
        run: |
          python -c "
          from PIL import Image
          img = Image.open('images/iconfeishuLOGO.png')
          img.resize((256, 256), Image.LANCZOS).save('icon.png')
          print('Generated icon.png')
          "

      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        run: |
          pyinstaller --noconfirm --onedir --windowed `
            --name "FeishuAssistant" `
            --icon "icon.ico" `
            --add-data "api;api" `
            --add-data "ui;ui" `
            --add-data "utils;utils" `
            --add-data "images/iconfeishuLOGO.png;images" `
            --hidden-import PySide6.QtCore `
            --hidden-import PySide6.QtGui `
            --hidden-import PySide6.QtWidgets `
            main.py

      - name: Build with PyInstaller (macOS)
        if: runner.os == 'macOS'
        run: |
          pyinstaller --noconfirm --onedir --windowed \
            --name "FeishuAssistant" \
            --icon "icon.icns" \
            --add-data "api:api" \
            --add-data "ui:ui" \
            --add-data "utils:utils" \
            --add-data "images/iconfeishuLOGO.png:images" \
            --hidden-import PySide6.QtCore \
            --hidden-import PySide6.QtGui \
            --hidden-import PySide6.QtWidgets \
            main.py

      - name: Build with PyInstaller (Linux)
        if: runner.os == 'Linux'
        run: |
          pyinstaller --noconfirm --onedir --windowed \
            --name "FeishuAssistant" \
            --icon "icon.png" \
            --add-data "api:api" \
            --add-data "ui:ui" \
            --add-data "utils:utils" \
            --add-data "images/iconfeishuLOGO.png:images" \
            --hidden-import PySide6.QtCore \
            --hidden-import PySide6.QtGui \
            --hidden-import PySide6.QtWidgets \
            main.py

      - name: Package artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/FeishuAssistant/*" -DestinationPath "${{ matrix.artifact_name }}.zip"

      - name: Package artifact (macOS)
        if: runner.os == 'macOS'
        run: |
          cd dist
          tar -czf "../${{ matrix.artifact_name }}.tar.gz" FeishuAssistant/
          cd ..

      - name: Package artifact (Linux)
        if: runner.os == 'Linux'
        run: |
          cd dist
          tar -czf "../${{ matrix.artifact_name }}.tar.gz" FeishuAssistant/
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.artifact_name }}.zip
            ${{ matrix.artifact_name }}.tar.gz
          if-no-files-found: ignore

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
